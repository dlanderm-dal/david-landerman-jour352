---
title: "Medicare_D_2023"
author: "David Landerman"
date: "2025-12-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(tidyverse)
library(janitor)
library(rio)
library(lubridate)
```

## Including Plots

You can also embed plots, for example:

```{r}
medicare_2023_d<-read_csv("medicare_d_2023_full_list.csv")
```

```{r}
medicare_2023_d_set1<-medicare_2023_d %>% 
  filter(Tot_Dsg_Unts_2023>1000000) %>% 
  arrange(desc("Avg_Spnd_Per_Dsg_Unt_Wghtd_2023")) %>% 
  filter(Mftr_Name!="Overall") %>% 
  filter(!Brnd_Name %in% c("Mounjaro", "Humira(Cf) Pen", "Enbrel Sureclick", "Dupixent Pen", "Trulicity", "Ozempic")) %>% 
  slice_head(n = 10)
```


START HERE
#bring in filtered medicare drug list
List was filtered:
Drugs with over 1million doses in 2023
Sorted by highest cost/dose in 2023
Eliminated all non pill administered drugs
Cut to the top 10
```{r}
medicare_historic_full<-read_csv("medicare_historic_corrected.csv") %>% 
  clean_names() %>% 
  slice_head(n=10)
  names(medicare_historic_full) <- sub("^x", "", names(medicare_historic_full))
```
```{r}
write.csv(medicare_historic_full, "DATAFRAMEFULL.csv", row.names = FALSE)
```


#Create Facet Tables
```{r}
total_dosage_units <- medicare_historic_full %>%
  select(brand_name, contains("total_dosage_units")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(total_dosage_units, "./facet/total_dosage_units.csv", row.names = FALSE)

total_spending<- medicare_historic_full %>%
  select(brand_name, contains("total_spending")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(total_spending, "./facet/total_spending.csv", row.names = FALSE)


total_claims <- medicare_historic_full %>%
  select(brand_name, contains("total_claims")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(total_claims, "./facet/total_claims.csv", row.names = FALSE)


total_beneficiaries <- medicare_historic_full %>%
  select(brand_name, contains("total_beneficiaries")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(total_beneficiaries, "./facet/total_beneficiaries.csv", row.names = FALSE)


average_spending_per_dosage_unit_weighted <- medicare_historic_full %>%
  select(brand_name, contains("average_spending_per_dosage_unit_weighted")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(average_spending_per_dosage_unit_weighted, "./facet/average_spending_per_dosage_unit_weighted.csv", row.names = FALSE)


average_spending_per_claim <- medicare_historic_full %>%
  select(brand_name, contains("average_spending_per_claim")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(average_spending_per_claim, "./facet/average_spending_per_claim.csv", row.names = FALSE)


average_spending_per_beneficiary <- medicare_historic_full %>%
  select(brand_name, contains("average_spending_per_beneficiary")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(average_spending_per_beneficiary, "./facet/average_spending_per_beneficiary.csv", row.names = FALSE)


```

#Create Percentage Tables
```{r}
cpi_context_dosage_cost <- read_csv("./facet/cpi_context_dose_cost.csv") %>%
  rename(`2019_value` = `2019`,
         `2020_value` = `2020`,
         `2021_value` = `2021`,
         `2022_value` = `2022`,
         `2023_value` = `2023`) %>%
  mutate(
    `2019` = 0,
    `2020` = (`2020_value` - `2019_value`) / `2019_value` * 100,
    `2021` = (`2021_value` - `2019_value`) / `2019_value` * 100,
    `2022` = (`2022_value` - `2019_value`) / `2019_value` * 100,
    `2023` = (`2023_value` - `2019_value`) / `2019_value` * 100
  ) %>% 
  select(brand_name,`2019`,`2020`,`2021`,`2022`,`2023`)
write.csv(cpi_context_dosage_cost, "./facet/cpi_context_dosage_cost_percent.csv", row.names = FALSE)

```

```{r}
total_spending_percent<-total_spending %>%
  rename(`2019_value` = `2019`,
         `2020_value` = `2020`,
         `2021_value` = `2021`,
         `2022_value` = `2022`,
         `2023_value` = `2023`) %>%
  mutate(
    `2019` = 0,
    `2020` = (`2020_value` - `2019_value`) / `2019_value` * 100,
    `2021` = (`2021_value` - `2019_value`) / `2019_value` * 100,
    `2022` = (`2022_value` - `2019_value`) / `2019_value` * 100,
    `2023` = (`2023_value` - `2019_value`) / `2019_value` * 100
  ) %>% 
  select(brand_name,`2019`,`2020`,`2021`,`2022`,`2023`)
write.csv(total_spending_percent, "./facet/total_spending_percent.csv", row.names = FALSE)

```

```{r}
full_medicare_d_unfiltered <- read_csv("full_medicare_d_unfiltered.csv") %>%
  clean_names()
  names(full_medicare_d_unfiltered) <- sub("^x", "", names(full_medicare_d_unfiltered))
write.csv(full_medicare_d_unfiltered, "full_medicare_d_unfiltered_clean.csv", row.names = FALSE)
  
thalidomide<-full_medicare_d_unfiltered %>% 
  filter(brand_name %in% c("Revlimid", "Thalomid", "Pomalidomide", "Pomalyst","Lenalidomide"))
```

#Create Facet Tables
```{r}
total_dosage_units_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("total_dosage_units")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(total_dosage_units_T, "./facet_T/total_dosage_units.csv", row.names = FALSE)
  
total_spending_T<- thalidomide %>%
  select(brand_name, manufacturer, contains("total_spending")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(total_spending_T, "./facet_T/total_spending.csv", row.names = FALSE)


total_claims_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("total_claims")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(total_claims_T, "./facet_T/total_claims.csv", row.names = FALSE)


total_beneficiaries_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("total_beneficiaries")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(total_beneficiaries_T, "./facet_T/total_beneficiaries.csv", row.names = FALSE)


average_spending_per_dosage_unit_weighted_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("average_spending_per_dosage_unit_weighted")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(average_spending_per_dosage_unit_weighted_T, "./facet_T/average_spending_per_dosage_unit_weighted.csv", row.names = FALSE)


average_spending_per_claim_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("average_spending_per_claim")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(average_spending_per_claim_T, "./facet_T/average_spending_per_claim.csv", row.names = FALSE)


average_spending_per_beneficiary_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("average_spending_per_beneficiary")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(average_spending_per_beneficiary_T, "./facet_T/average_spending_per_beneficiary.csv", row.names = FALSE)


```

#HOW DO DRUG PRICES COME DOWN
```{r}
generic_price_deflation<-full_medicare_d_unfiltered %>% 
  group_by(generic_name) %>% 
  summarize(
    
    doses_given_2023=sum(`2023_total_dosage_units`),
    number_of_manufacturers_2019 = sum(!is.na(`2019_total_spending`)),
    number_of_manufacturers_2020 = sum(!is.na(`2020_total_spending`)),
    number_of_manufacturers_2021 = sum(!is.na(`2021_total_spending`)),
    number_of_manufacturers_2022 = sum(!is.na(`2022_total_spending`)),
    number_of_manufacturers_2023 = sum(!is.na(`2023_total_spending`)),
    
    manufacturer_2019 = first(manufacturer[!is.na(`2019_total_spending`)]),
brand_name_2019 = first(brand_name[!is.na(`2019_total_spending`)]),
    
    
    max_cost_per_dose_2019 = if_else(number_of_manufacturers_2019 == 0, NA, max(`2019_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    min_cost_per_dose_2019 = if_else(number_of_manufacturers_2019 == 0, NA, min(`2019_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    max_cost_per_dose_2020 = if_else(number_of_manufacturers_2020 == 0, NA, max(`2020_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    min_cost_per_dose_2020 = if_else(number_of_manufacturers_2020 == 0, NA, min(`2020_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    max_cost_per_dose_2021 = if_else(number_of_manufacturers_2021 == 0, NA, max(`2021_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    min_cost_per_dose_2021 = if_else(number_of_manufacturers_2021 == 0, NA, min(`2021_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    max_cost_per_dose_2022 = if_else(number_of_manufacturers_2022 == 0, NA, max(`2022_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    min_cost_per_dose_2022 = if_else(number_of_manufacturers_2022 == 0, NA, min(`2022_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    max_cost_per_dose_2023 = if_else(number_of_manufacturers_2023 == 0, NA, max(`2023_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    min_cost_per_dose_2023 = if_else(number_of_manufacturers_2023 == 0, NA, min(`2023_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    .groups = 'drop'
  ) %>% 
  #drugs that were on the market in 2019 (i.e. had same time to deflate as revlimid)
  filter(number_of_manufacturers_2019==1) %>% 
  #drugs that had generics produced by 2023 and had time to deflate)
  filter(number_of_manufacturers_2023>1) %>% 
  #filtering out small run productions
  filter(doses_given_2023>1000000) %>% 
  #create price drop and price drop percentage
  mutate(price_drop=min_cost_per_dose_2023-min_cost_per_dose_2019) %>%
  mutate(price_drop_percentage=((min_cost_per_dose_2023-min_cost_per_dose_2019)/min_cost_per_dose_2019)) %>% 
  #filter out extremely low cost drugs with negligible room for cost cutting
  filter(min_cost_per_dose_2019>.25) %>% 
  mutate(change_in_manufacturers=number_of_manufacturers_2023-number_of_manufacturers_2019)

write.csv(generic_price_deflation, "./facet_T/generic_price_deflation.csv", row.names = FALSE)


generic_price_deflation %>% 
    group_by(manufacturer_2019) %>% 
             summarize(
               manufacturer_frequency=n()
             ) %>% 
          arrange(desc(manufacturer_frequency))

```


```{r}
# After creating generic_price_deflation...
manufacturer_counts <- generic_price_deflation %>%
  count(manufacturer_2019, name = "manufacturer_frequency")

generic_price_deflation <- generic_price_deflation %>%
  left_join(manufacturer_counts, by = "manufacturer_2019")

write.csv(generic_price_deflation, "./facet_T/generic_price_deflation.csv", row.names = FALSE)
```




```{r}
ggplot(generic_price_deflation, aes(x = change_in_manufacturers, y = price_drop_percentage)) +
  geom_point() +
  labs(x = "Change in Manufacturers", y = "Price Drop Percentage")
```

Line of Best Fit
```{r}
model <- lm(price_drop_percentage ~ change_in_manufacturers, data = generic_price_deflation)

ggplot(generic_price_deflation, aes(x = change_in_manufacturers, y = price_drop_percentage)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Change in Manufacturers", y = "Price Drop Percentage")
```

full equation, the R^2 value, the y value on that line when x=1 and y=-1
```{r}
slope <- coef(model)[2]
intercept <- coef(model)[1]
r_squared <- summary(model)$r.squared
y_at_x1 <- intercept + slope * 1
x_at_y_neg1 <- (-1 - intercept) / slope
cat("Equation: y =", round(slope, 4), "* x +", round(intercept, 4), "\n")
cat("R² =", round(r_squared, 4), "\n")
cat("Point 1: (1,", round(y_at_x1, 4), ")\n")
cat("Point 2: (", round(x_at_y_neg1, 4), ", -1)\n")
```
Create a filtered dataset with y>0 omitted

```{r}
filtered_for_price_drop <- generic_price_deflation %>%
  filter(price_drop_percentage <= 0)
```

Calculate each point's vertical distance from the best fit line
```{r}
filtered_for_price_drop <- filtered_for_price_drop %>%
  mutate(
    predicted = intercept + slope * change_in_manufacturers,
    residual = price_drop_percentage - predicted
  )
```
Find upper and lower bounds capturing 90% of filtered points
```{r}
lower_bound <- quantile(filtered_for_price_drop$residual, 0.05)
upper_bound <- quantile(filtered_for_price_drop$residual, 0.95)

cat("Lower bound (5th percentile):", round(lower_bound, 4), "\n")
cat("Upper bound (95th percentile):", round(upper_bound, 4), "\n")
```

Step 6: Display equations for upper and lower bounds, R², and y value at x=1 and the x value y=-1
```{r}
# The bounds are parallel lines (same slope, shifted intercepts)
intercept_upper <- intercept + upper_bound
intercept_lower <- intercept + lower_bound
y_upper_at_x1 <- intercept_upper + slope * 1
x_upper_at_y_neg1 <- (-1 - intercept_upper) / slope
y_lower_at_x1 <- intercept_lower + slope * 1
x_lower_at_y_neg1 <- (-1 - intercept_lower) / slope
cat("Upper bound: y =", round(slope, 4), "* x +", round(intercept_upper, 4), "\n")
cat("Point 1: (1,", round(y_upper_at_x1, 4), ")\n")
cat("Point 2: (", round(x_upper_at_y_neg1, 4), ", -1)\n\n")
cat("Lower bound: y =", round(slope, 4), "* x +", round(intercept_lower, 4), "\n")
cat("Point 1: (1,", round(y_lower_at_x1, 4), ")\n")
cat("Point 2: (", round(x_lower_at_y_neg1, 4), ", -1)\n")
```

```{r}
ggplot(generic_price_deflation, aes(x = change_in_manufacturers, y = price_drop_percentage)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_abline(intercept = intercept_upper, slope = slope, linetype = "dashed") +
  geom_abline(intercept = intercept_lower, slope = slope, linetype = "dashed") +
  labs(x = "Change in Manufacturers", y = "Price Drop Percentage")
```

```{r}
# 8. Datawrapper notation
x_min <- min(generic_price_deflation$change_in_manufacturers)
x_max <- max(generic_price_deflation$change_in_manufacturers)

y_lower_at_xmin <- intercept_lower + slope * x_min
y_lower_at_xmax <- intercept_lower + slope * x_max
y_upper_at_xmin <- intercept_upper + slope * x_min
y_upper_at_xmax <- intercept_upper + slope * x_max

cat("TRENDLINE:\n")
cat("y =", round(slope, 4), "* x +", round(intercept, 4), "\n\n")

cat("SHADED AREA:\n")
cat(round(x_min, 2), ",", round(y_lower_at_xmin, 2), ",", 
    round(x_min, 2), ",", round(y_upper_at_xmin, 2), ",",
    round(x_max, 2), ",", round(y_upper_at_xmax, 2), ",",
    round(x_max, 2), ",", round(y_lower_at_xmax, 2),
    " @color:gray @opacity:0.3\n")
```

