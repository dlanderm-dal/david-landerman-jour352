---
title: "Medicare_D_2023"
author: "David Landerman"
date: "2025-12-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(tidyverse)
library(janitor)
library(rio)
library(lubridate)
```

Scratch work
#```{r}
medicare_2023_d<-read_csv("medicare_d_2023_full_list.csv")
```

#```{r}
#medicare_2023_d_set1<-medicare_2023_d %>% 
  filter(Tot_Dsg_Unts_2023>1000000) %>% 
  arrange(desc("Avg_Spnd_Per_Dsg_Unt_Wghtd_2023")) %>% 
  filter(Mftr_Name!="Overall") %>% 
  filter(!Brnd_Name %in% c("Mounjaro", "Humira(Cf) Pen", "Enbrel Sureclick", "Dupixent Pen", "Trulicity", "Ozempic")) %>% 
  slice_head(n = 10)
```


```{r}
extended_medicare_2012_2016<-read_csv("./fresh_start/2012-2016_b_wayback.csv") %>% 
  clean_names()
extended_medicare_2017_2018<-read_csv("./fresh_start/2017-2018_wayback.csv") %>% 
  clean_names() %>% 
  filter(manufacturer!="Overall")
extended_medicare_2019_2023<-read_csv("./fresh_start/2019-2023_cms.csv") %>% 
  clean_names()

extended_medicare_2012_2016 <- extended_medicare_2012_2016 %>%
  mutate(manufacturer = if_else(manufacturer == "Celgene", "Celgene/BMS", manufacturer))

extended_medicare_2017_2018 <- extended_medicare_2017_2018 %>%
  mutate(manufacturer = if_else(manufacturer == "Celgene", "Celgene/BMS", manufacturer))

extended_medicare_2019_2023 <- extended_medicare_2019_2023 %>%
  mutate(manufacturer = if_else(manufacturer == "Celgene", "Celgene/BMS", manufacturer))

extended_medicare_full_2012_2023 <- extended_medicare_2012_2016 %>%
  full_join(extended_medicare_2017_2018, by = c("brand_name", "generic_name", "manufacturer")) %>%
  full_join(extended_medicare_2019_2023, by = c("brand_name", "generic_name", "manufacturer"))

extended_medicare_full_2012_2023 <- extended_medicare_full_2012_2023 %>%
  mutate(across(4:ncol(.), ~ as.numeric(str_remove_all(., "[$,]"))))


names(extended_medicare_full_2012_2023) <- sub("^x", "", names(extended_medicare_full_2012_2023))

```

```{r}
#find top 10 2023
top_ten_2023<-extended_medicare_full_2012_2023 %>% 
  filter('2023_total_dosage_units'>1000000) %>% 
  arrange(desc('2023_average_spending_per_dosage_unit_weighted')) %>% 
  slice_head(n=20) %>% 
  filter(!brand_name %in% c("Humira(Cf) Pen", "Enbrel Sureclick", "Dupixent Pen", "Mounjaro", "Trulicity")) %>% 
  slice_head(n=10)

  
```



```{r}
top_ten_2023_graphic<-top_ten_2023 %>% 
  select(brand_name, `2023_total_beneficiaries`,`2023_average_spending_per_dosage_unit_weighted`,`2023_average_spending_per_beneficiary`,`2023_total_spending`,manufacturer,`2023_total_dosage_units`)
#Datawrapper graphic
```


START HERE
#bring in filtered medicare drug list source:
https://data.cms.gov/summary-statistics-on-use-and-payments/medicare-medicaid-spending-by-drug/medicare-part-d-spending-by-drug
List was filtered:
Drugs with over 1million doses in 2023
Sorted by highest cost/dose in 2023
Eliminated all non pill administered drugs
Cut to the top 10
#```{r}
medicare_historic_full<-read_csv("medicare_historic_corrected.csv") %>% 
  clean_names() %>% 
  slice_head(n=10)
  names(medicare_historic_full) <- sub("^x", "", names(medicare_historic_full))
```
#```{r}
write.csv(medicare_historic_full, "DATAFRAMEFULL.csv", row.names = FALSE)
```


#Create Facet Tables
```{r}
total_dosage_units <- top_ten_2023 %>%
  select(brand_name, contains("total_dosage_units")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(total_dosage_units, "./fresh_start/facet/total_dosage_units.csv", row.names = FALSE)

total_spending<- top_ten_2023 %>%
  select(brand_name, contains("total_spending")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(total_spending, "./fresh_start/facet/total_spending.csv", row.names = FALSE)
  #DATAWRAPPER GRAPH


total_claims <- top_ten_2023 %>%
  select(brand_name, contains("total_claims")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(total_claims, "./fresh_start/facet/total_claims.csv", row.names = FALSE)


total_beneficiaries <- top_ten_2023 %>%
  select(brand_name, contains("total_beneficiaries")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(total_beneficiaries, "./fresh_start/facet/total_beneficiaries.csv", row.names = FALSE)


average_spending_per_dosage_unit_weighted <- top_ten_2023 %>%
  select(brand_name, contains("average_spending_per_dosage_unit_weighted")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(average_spending_per_dosage_unit_weighted, "./fresh_start/facet/average_spending_per_dosage_unit_weighted.csv", row.names = FALSE)


average_spending_per_claim <- top_ten_2023 %>%
  select(brand_name, contains("average_spending_per_claim")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(average_spending_per_claim, "./fresh_start/facet/average_spending_per_claim.csv", row.names = FALSE)


average_spending_per_beneficiary <- top_ten_2023 %>%
  select(brand_name, contains("average_spending_per_beneficiary")) %>% 
  rename_with(~substr(., 1, 4), -brand_name)
  write.csv(average_spending_per_beneficiary, "./fresh_start/facet/average_spending_per_beneficiary.csv", row.names = FALSE)


```

```{r}
cpi_value<-read_csv("./fresh_start/cpi_value.csv") %>%
  clean_names() %>% 
 
  filter(year>2011&year<2024)
cpi_value_wide <- cpi_value %>%
  select(year, avg) %>%
  pivot_wider(names_from = year, values_from = avg) %>% 
  mutate(brand_name = "CPI")

```

```{r}
cpi_context_dosage_cost <- average_spending_per_dosage_unit_weighted %>%
  bind_rows(cpi_value_wide)
```





#Create Percentage Tables
```{r}
cpi_percentage<-cpi_context_dosage_cost  %>%
  rename(
    `2012_value` = `2012`,
    `2013_value` = `2013`,
    `2014_value` = `2014`,
    `2015_value` = `2015`,
    `2016_value` = `2016`,
    `2017_value` = `2017`,
    `2018_value` = `2018`,
    `2019_value` = `2019`,
    `2020_value` = `2020`,
    `2021_value` = `2021`,
    `2022_value` = `2022`,
    `2023_value` = `2023`
  ) %>%
  rowwise() %>%
  mutate(
    first_value = coalesce(`2012_value`, `2013_value`, `2014_value`, `2015_value`, 
                           `2016_value`, `2017_value`, `2018_value`, `2019_value`,
                           `2020_value`, `2021_value`, `2022_value`, `2023_value`),
    `2012` = (`2012_value` - first_value) / first_value * 100,
    `2013` = (`2013_value` - first_value) / first_value * 100,
    `2014` = (`2014_value` - first_value) / first_value * 100,
    `2015` = (`2015_value` - first_value) / first_value * 100,
    `2016` = (`2016_value` - first_value) / first_value * 100,
    `2017` = (`2017_value` - first_value) / first_value * 100,
    `2018` = (`2018_value` - first_value) / first_value * 100,
    `2019` = (`2019_value` - first_value) / first_value * 100,
    `2020` = (`2020_value` - first_value) / first_value * 100,
    `2021` = (`2021_value` - first_value) / first_value * 100,
    `2022` = (`2022_value` - first_value) / first_value * 100,
    `2023` = (`2023_value` - first_value) / first_value * 100
  ) %>%
  ungroup() %>%
  select(brand_name, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, 
         `2019`, `2020`, `2021`, `2022`, `2023`)
write.csv(cpi_percentage, "./fresh_start/facet/cpi_dosage_percent_change.csv", row.names = FALSE)

#DATAWRAPPER GRAPH
 
```

```{r}
total_spending_percent<-total_spending %>%
  rename(
    `2012_value` = `2012`,
    `2013_value` = `2013`,
    `2014_value` = `2014`,
    `2015_value` = `2015`,
    `2016_value` = `2016`,
    `2017_value` = `2017`,
    `2018_value` = `2018`,
    `2019_value` = `2019`,
    `2020_value` = `2020`,
    `2021_value` = `2021`,
    `2022_value` = `2022`,
    `2023_value` = `2023`
  ) %>%
  rowwise() %>%
  mutate(
    first_value = coalesce(`2012_value`, `2013_value`, `2014_value`, `2015_value`, 
                           `2016_value`, `2017_value`, `2018_value`, `2019_value`,
                           `2020_value`, `2021_value`, `2022_value`, `2023_value`),
    `2012` = (`2012_value` - first_value) / first_value * 100,
    `2013` = (`2013_value` - first_value) / first_value * 100,
    `2014` = (`2014_value` - first_value) / first_value * 100,
    `2015` = (`2015_value` - first_value) / first_value * 100,
    `2016` = (`2016_value` - first_value) / first_value * 100,
    `2017` = (`2017_value` - first_value) / first_value * 100,
    `2018` = (`2018_value` - first_value) / first_value * 100,
    `2019` = (`2019_value` - first_value) / first_value * 100,
    `2020` = (`2020_value` - first_value) / first_value * 100,
    `2021` = (`2021_value` - first_value) / first_value * 100,
    `2022` = (`2022_value` - first_value) / first_value * 100,
    `2023` = (`2023_value` - first_value) / first_value * 100
  ) %>%
  ungroup() %>%
  select(brand_name, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, 
         `2019`, `2020`, `2021`, `2022`, `2023`)
write.csv(total_spending_percent, "./fresh_start/facet/total_spending_percent.csv", row.names = FALSE)

```

```{r}

thalidomide<-extended_medicare_full_2012_2023 %>% 
  filter(brand_name %in% c("Revlimid", "Thalomid", "Pomalidomide", "Pomalyst","Lenalidomide"))
```

#Create Facet Tables
```{r}
total_dosage_units_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("total_dosage_units")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(total_dosage_units_T, "./fresh_start/facet_T/total_dosage_units.csv", row.names = FALSE)
  
total_spending_T<- thalidomide %>%
  select(brand_name, manufacturer, contains("total_spending")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(total_spending_T, "./fresh_start/facet_T/total_spending.csv", row.names = FALSE)


total_claims_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("total_claims")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(total_claims_T, "./fresh_start/facet_T/total_claims.csv", row.names = FALSE)


total_beneficiaries_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("total_beneficiaries")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(total_beneficiaries_T, "./fresh_start/facet_T/total_beneficiaries.csv", row.names = FALSE)


average_spending_per_dosage_unit_weighted_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("average_spending_per_dosage_unit_weighted")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(average_spending_per_dosage_unit_weighted_T, "./fresh_start/facet_T/average_spending_per_dosage_unit_weighted.csv", row.names = FALSE)


average_spending_per_claim_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("average_spending_per_claim")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(average_spending_per_claim_T, "./fresh_start/facet_T/average_spending_per_claim.csv", row.names = FALSE)


average_spending_per_beneficiary_T <- thalidomide %>%
  select(brand_name, manufacturer, contains("average_spending_per_beneficiary")) %>% 
  rename_with(~substr(., 1, 4), !c(brand_name, manufacturer))
  write.csv(average_spending_per_beneficiary_T, "./fresh_start/facet_T/average_spending_per_beneficiary.csv", row.names = FALSE)


```


```{r}
generic_price_deflation<-extended_medicare_full_2012_2023 %>% 
  select(-matches("^201[2-8]"))
```

```{r}
full_medicare_d_unfiltered<-read_csv("./fresh_start/full_medicare_d_unfiltered.csv") %>% 
  clean_names()
  names(full_medicare_d_unfiltered) <- sub("^x", "", names(full_medicare_d_unfiltered))
```




#HOW DO DRUG PRICES COME DOWN
```{r}
generic_price_deflation1<- full_medicare_d_unfiltered%>% 
  
  
  group_by(generic_name) %>% 
  summarize(
    
    doses_given_2023=sum(`2023_total_dosage_units`),
    number_of_manufacturers_2019 = sum(!is.na(`2019_total_spending`)),
    number_of_manufacturers_2020 = sum(!is.na(`2020_total_spending`)),
    number_of_manufacturers_2021 = sum(!is.na(`2021_total_spending`)),
    number_of_manufacturers_2022 = sum(!is.na(`2022_total_spending`)),
    number_of_manufacturers_2023 = sum(!is.na(`2023_total_spending`)),
    
    manufacturer_2019 = first(manufacturer[!is.na(`2019_total_spending`)]),
brand_name_2019 = first(brand_name[!is.na(`2019_total_spending`)]),
    
    
    max_cost_per_dose_2019 = if_else(number_of_manufacturers_2019 == 0, NA, max(`2019_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    min_cost_per_dose_2019 = if_else(number_of_manufacturers_2019 == 0, NA, min(`2019_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    max_cost_per_dose_2020 = if_else(number_of_manufacturers_2020 == 0, NA, max(`2020_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    min_cost_per_dose_2020 = if_else(number_of_manufacturers_2020 == 0, NA, min(`2020_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    max_cost_per_dose_2021 = if_else(number_of_manufacturers_2021 == 0, NA, max(`2021_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    min_cost_per_dose_2021 = if_else(number_of_manufacturers_2021 == 0, NA, min(`2021_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    max_cost_per_dose_2022 = if_else(number_of_manufacturers_2022 == 0, NA, max(`2022_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    min_cost_per_dose_2022 = if_else(number_of_manufacturers_2022 == 0, NA, min(`2022_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    max_cost_per_dose_2023 = if_else(number_of_manufacturers_2023 == 0, NA, max(`2023_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    min_cost_per_dose_2023 = if_else(number_of_manufacturers_2023 == 0, NA, min(`2023_average_spending_per_dosage_unit_weighted`, na.rm = TRUE)),
    .groups = 'drop'
  ) %>% 
  #drugs that were on the market in 2019 (i.e. had same time to deflate as revlimid)
  filter(number_of_manufacturers_2019==1) %>% 
  #drugs that had generics produced by 2023 and had time to deflate)
  filter(number_of_manufacturers_2023>1) %>% 
  #filtering out small run productions
  filter(doses_given_2023>1000000) %>% 
  #create price drop and price drop percentage
  mutate(price_drop=min_cost_per_dose_2023-min_cost_per_dose_2019) %>%
  mutate(price_drop_percentage=((min_cost_per_dose_2023-min_cost_per_dose_2019)/min_cost_per_dose_2019)) %>% 
  #filter out extremely low cost drugs with negligible room for cost cutting
  filter(min_cost_per_dose_2019>.25) %>% 
  mutate(change_in_manufacturers=number_of_manufacturers_2023-number_of_manufacturers_2019)

write.csv(generic_price_deflation1, "./fresh_start/facet_T/generic_price_deflation.csv", row.names = FALSE)


generic_price_deflation1 %>% 
    group_by(manufacturer_2019) %>% 
             summarize(
               manufacturer_frequency=n()
             ) %>% 
          arrange(desc(manufacturer_frequency))

#DATAWRAPPER GRAPH
#TO DIAGNOSE: WHY IS THIS DATASET DIFFERENT FROM FULL MEDICARE 2012-2023

```


```{r}
# After creating generic_price_deflation...
manufacturer_counts <- generic_price_deflation %>%
  count(manufacturer_2019, name = "manufacturer_frequency")

generic_price_deflation <- generic_price_deflation %>%
  left_join(manufacturer_counts, by = "manufacturer_2019")

write.csv(generic_price_deflation, "./facet_T/generic_price_deflation.csv", row.names = FALSE)
```




```{r}
ggplot(generic_price_deflation, aes(x = change_in_manufacturers, y = price_drop_percentage)) +
  geom_point() +
  labs(x = "Change in Manufacturers", y = "Price Drop Percentage")
```

Line of Best Fit
```{r}
model <- lm(price_drop_percentage ~ change_in_manufacturers, data = generic_price_deflation)

ggplot(generic_price_deflation, aes(x = change_in_manufacturers, y = price_drop_percentage)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Change in Manufacturers", y = "Price Drop Percentage")
```

full equation, the R^2 value, the y value on that line when x=1 and y=-1
```{r}
slope <- coef(model)[2]
intercept <- coef(model)[1]
r_squared <- summary(model)$r.squared
y_at_x1 <- intercept + slope * 1
x_at_y_neg1 <- (-1 - intercept) / slope
cat("Equation: y =", round(slope, 4), "* x +", round(intercept, 4), "\n")
cat("R² =", round(r_squared, 4), "\n")
cat("Point 1: (1,", round(y_at_x1, 4), ")\n")
cat("Point 2: (", round(x_at_y_neg1, 4), ", -1)\n")
```
Create a filtered dataset with y>0 omitted

```{r}
filtered_for_price_drop <- generic_price_deflation %>%
  filter(price_drop_percentage <= 0)
```

Calculate each point's vertical distance from the best fit line
```{r}
filtered_for_price_drop <- filtered_for_price_drop %>%
  mutate(
    predicted = intercept + slope * change_in_manufacturers,
    residual = price_drop_percentage - predicted
  )
```
Find upper and lower bounds capturing 90% of filtered points
```{r}
lower_bound <- quantile(filtered_for_price_drop$residual, 0.05)
upper_bound <- quantile(filtered_for_price_drop$residual, 0.95)

cat("Lower bound (5th percentile):", round(lower_bound, 4), "\n")
cat("Upper bound (95th percentile):", round(upper_bound, 4), "\n")
```

Step 6: Display equations for upper and lower bounds, R², and y value at x=1 and the x value y=-1
```{r}
# The bounds are parallel lines (same slope, shifted intercepts)
intercept_upper <- intercept + upper_bound
intercept_lower <- intercept + lower_bound
y_upper_at_x1 <- intercept_upper + slope * 1
x_upper_at_y_neg1 <- (-1 - intercept_upper) / slope
y_lower_at_x1 <- intercept_lower + slope * 1
x_lower_at_y_neg1 <- (-1 - intercept_lower) / slope
cat("Upper bound: y =", round(slope, 4), "* x +", round(intercept_upper, 4), "\n")
cat("Point 1: (1,", round(y_upper_at_x1, 4), ")\n")
cat("Point 2: (", round(x_upper_at_y_neg1, 4), ", -1)\n\n")
cat("Lower bound: y =", round(slope, 4), "* x +", round(intercept_lower, 4), "\n")
cat("Point 1: (1,", round(y_lower_at_x1, 4), ")\n")
cat("Point 2: (", round(x_lower_at_y_neg1, 4), ", -1)\n")
```

```{r}
ggplot(generic_price_deflation, aes(x = change_in_manufacturers, y = price_drop_percentage)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_abline(intercept = intercept_upper, slope = slope, linetype = "dashed") +
  geom_abline(intercept = intercept_lower, slope = slope, linetype = "dashed") +
  labs(x = "Change in Manufacturers", y = "Price Drop Percentage")
```

```{r}
# 8. Datawrapper notation
x_min <- min(generic_price_deflation$change_in_manufacturers)
x_max <- max(generic_price_deflation$change_in_manufacturers)

y_lower_at_xmin <- intercept_lower + slope * x_min
y_lower_at_xmax <- intercept_lower + slope * x_max
y_upper_at_xmin <- intercept_upper + slope * x_min
y_upper_at_xmax <- intercept_upper + slope * x_max

cat("TRENDLINE:\n")
cat("y =", round(slope, 4), "* x +", round(intercept, 4), "\n\n")

cat("SHADED AREA:\n")
cat(round(x_min, 2), ",", round(y_lower_at_xmin, 2), ",", 
    round(x_min, 2), ",", round(y_upper_at_xmin, 2), ",",
    round(x_max, 2), ",", round(y_upper_at_xmax, 2), ",",
    round(x_max, 2), ",", round(y_lower_at_xmax, 2),
    " @color:gray @opacity:0.3\n")
```
#Revlimid Price History

Step 1: Load Revlimid Filtered Medicare Data-This would be broken down from step 1 were this a data project but I did it in excel
```{r}
revlimid_medicare_dose_cost<-read_csv("Revlimid_Medicare.csv", skip=1) %>% 
  clean_names() %>% 
  mutate(medicare_avg_cost_unit = as.numeric(gsub("[$,]", "", medicare_avg_cost_unit))) %>% 
  mutate(medicare_avg_cost_unit = round(medicare_avg_cost_unit, 2)) %>% 
  glimpse()

```

```{r}
revlimid_medicare_dose_cost <- revlimid_medicare_dose_cost %>%
  rowwise() %>%
  mutate(date = list(c(ymd(paste0(year, "-01-01")), ymd(paste0(year, "-12-31"))))) %>%
  unnest(date) %>%
  ungroup() 
```

Step 2 Load in historic Price Info
```{r}
revlimid_full_list_price_history<-read_csv("Revlimid_List_Price.csv", skip=1) %>% 
  slice(1:(n()-8)) %>% 
  clean_names() %>% 
  mutate(effective_date=mdy(effective_date))
glimpse(revlimid_full_list_price_history)
  
```
Bring to wide format, pivot table
```{r}
revlimid_wide <- revlimid_full_list_price_history %>%
  mutate(drug_id = paste(identifier, dosage, package_size, sep = "_")) %>%
  select(effective_date, drug_id, unit) %>%
  pivot_wider(names_from = drug_id, values_from = unit)
```

Fill in blank spots with previously known prices
```{r}
revlimid_wide_fill <- revlimid_wide %>%
  arrange(effective_date) %>%
  fill(everything(), .direction = "down")
```

Create Averages
```{r}
revlimid_wide_fill <- revlimid_wide_fill %>%
  mutate(avg_price = rowMeans(select(., -effective_date), na.rm = TRUE))
```

Slim down datasets to just whats going into datawrapper, join
```{r}
revlimid_avg_prices_dw <- revlimid_wide_fill %>%
  select(date = effective_date, avg_price)

revlimid_medicare_dose_dw <- revlimid_medicare_dose_cost %>%
  select(date, medicare_avg_cost_unit)

#revlimid average price per dose history compared with revilimid medicare spending
dw_revlimid_price_hist_medicare_comp <- revlimid_avg_prices_dw %>%
  full_join(revlimid_medicare_dose_dw, by = "date")

```


Fill down
```{r}
dw_revlimid_price_hist_medicare_comp <- dw_revlimid_price_hist_medicare_comp %>%
  arrange(date) %>%
  fill(avg_price, .direction = "down") %>%
  mutate(year = year(date)) %>%
  group_by(year) %>%
  fill(medicare_avg_cost_unit, .direction = "down") %>%
  ungroup()
```

```{r}
write.csv(dw_revlimid_price_hist_medicare_comp, "datawrapper_revlimid_medicare_price_comparison.csv", row.names = FALSE, na="")
```

Revlimid Inflation Comparison

```{r}
revlimid_5mg <- revlimid_wide_fill %>%
  select(effective_date, `59572-0405-00_5 mg_100s ea`)
```


Inflation Rates
```{r}
Inflation_Rates<-read_csv("Inflation_Rates.csv") %>%
  select(-Ave) %>%
  pivot_longer(cols = -Year, names_to = "month", values_to = "rate") %>% 
  filter(!is.na(Year))
```
```{r}
Inflation_Rates_dates <- Inflation_Rates %>%
  mutate(date = ymd(paste(Year, month, "01", sep = "-")))
head(Inflation_Rates)
```

```{r}
Inflation_Rates_dates <- Inflation_Rates_dates %>%
  filter(date >= ymd("2005-12-01"))
```

Inflating Start Price of 258 dollars
```{r}
Inflation_Rates_final <- Inflation_Rates_dates %>%
  arrange(date) %>%
  mutate(
    rate_monthly = (rate / 100) / 12,
    #divide by 12 for annual->monthly
    inflated_value = 258 * cumprod(1 + rate_monthly)
  )
```

Join With 5 mg
```{r}
inflation_join <- Inflation_Rates_final %>%
  select(date, inflated_value)

revlimid_5mg_inflation <- revlimid_5mg %>%
  full_join(inflation_join, by = c("effective_date" = "date")) %>%
  arrange(effective_date)

```
```{r}
write.csv(revlimid_5mg_inflation, "dw_revlimid_5mg_history_inflation.csv", row.names = FALSE, na="")
```

