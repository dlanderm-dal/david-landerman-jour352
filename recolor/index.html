<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recolor Preview Tool</title>

    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src https://fonts.gstatic.com; img-src 'self' data: blob: https://cdn-icons-png.flaticon.com; connect-src 'none';">
    <script src="numeric.min.js"></script>
    <script src="panzoom.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top-row">
                <div class="header-logo">
                    <!-- Tall logo: visible on initial page load, hidden once image uploaded -->
                    <svg id="logoTall" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 185" class="logo-svg logo-tall">
                        <defs>
                            <style>
                                .logo-c0{fill:#48d1cc}.logo-c1{fill:#f5427b}.logo-c3{fill:#1b8aad}.logo-c4{fill:#3dc8ff}.logo-c5{fill:none;stroke:#c8d6df;stroke-linecap:round;stroke-width:1.5px}.logo-c6{fill:#2b9eb3;font-family:Helvetica-Light,Helvetica;font-weight:300;font-size:36.31px;letter-spacing:-.02em}.logo-c7{isolation:isolate}.logo-c8{fill:#a0b4c4;font-family:Helvetica,Helvetica;font-size:15.36px;isolation:isolate}.logo-c9{fill:#1e3a4f;font-family:Helvetica-Bold,Helvetica;font-weight:700;font-size:36.31px;letter-spacing:-.02em;isolation:isolate}.logo-c10{fill:#0f4c81}.logo-c11{fill:#ff6b35}.logo-c12{fill:#ff8a4c}.logo-c13{fill:#ffe44d}.logo-c14{fill:#e23d6e}.logo-c15{fill:#c8d6df}.logo-c16{fill:#a855f7}.logo-c17{fill:#34d399}
                            </style>
                        </defs>
                        <g class="logo-c7"><text class="logo-c9" transform="translate(0 32.84)"><tspan x="0" y="0">Recolor</tspan></text></g>
                        <rect class="logo-c11" x="138.02" y="2.23" width="33.51" height="33.51" rx="5" ry="5"/>
                        <rect class="logo-c1" x="16.53" y="46.91" width="33.51" height="33.51" rx="5" ry="5"/>
                        <rect class="logo-c14" x="57.03" y="46.91" width="33.51" height="33.51" rx="5" ry="5"/>
                        <rect class="logo-c13" x="97.52" y="46.91" width="33.51" height="33.51" rx="5" ry="5"/>
                        <rect class="logo-c4" x="138.02" y="46.91" width="33.51" height="33.51" rx="5" ry="5"/>
                        <rect class="logo-c12" x="57.03" y="91.6" width="33.51" height="33.51" rx="5" ry="5"/>
                        <rect class="logo-c16" x="97.52" y="91.6" width="33.51" height="33.51" rx="5" ry="5"/>
                        <rect class="logo-c17" x="138.02" y="91.6" width="33.51" height="33.51" rx="5" ry="5"/>
                        <line class="logo-c5" x1="178.51" y1="18.98" x2="222.89" y2="18.98"/>
                        <line class="logo-c5" x1="178.51" y1="63.67" x2="222.89" y2="63.67"/>
                        <polygon class="logo-c15" points="211.76 55.43 226.17 63.84 211.76 72.25 211.76 55.43"/>
                        <line class="logo-c5" x1="178.51" y1="108.35" x2="222.89" y2="108.35"/>
                        <rect class="logo-c10" x="228.78" y="2.23" width="33.51" height="33.51" rx="5" ry="5"/>
                        <rect class="logo-c3" x="228.78" y="46.91" width="33.51" height="33.51" rx="5" ry="5"/>
                        <rect class="logo-c0" x="228.78" y="91.6" width="33.51" height="33.51" rx="5" ry="5"/>
                        <g class="logo-c7"><text class="logo-c6" transform="translate(60.26 158.62)"><tspan x="0" y="0">Preview Tool</tspan></text></g>
                        <g class="logo-c7"><text class="logo-c8" transform="translate(23.51 179.47)"><tspan x="0" y="0">Ineptly vibe-coded by David Landerman</tspan></text></g>
                        <polygon class="logo-c15" points="211.76 10.58 226.17 18.98 211.76 27.39 211.76 10.58"/>
                        <polygon class="logo-c15" points="211.76 99.95 226.17 108.35 211.76 116.76 211.76 99.95"/>
                    </svg>
                    <!-- Short logo: shown after image is uploaded -->
                    <svg id="logoShort" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 95" class="logo-svg logo-short" style="display:none;">
                        <defs>
                            <style>
                                .logo-s0{fill:#f5427b}.logo-s1{fill:#1b8aad}.logo-s2{fill:#3dc8ff}.logo-s3{fill:none;stroke:#c8d6df;stroke-linecap:round;stroke-width:1.5px}.logo-s4{letter-spacing:-.02em}.logo-s4,.logo-s5{fill:#2b9eb3;font-family:Helvetica-Light,Helvetica;font-weight:300}.logo-s4,.logo-s5,.logo-s6{font-size:26.84px;isolation:isolate}.logo-s5,.logo-s6{letter-spacing:-.02em}.logo-s6{fill:#1e3a4f;font-family:Helvetica-Bold,Helvetica;font-weight:700}.logo-s7{isolation:isolate}.logo-s8{fill:#a0b4c4;font-family:Helvetica,Helvetica;font-size:11.35px;isolation:isolate}.logo-s9{fill:#0f4c81}.logo-s10{fill:#ff6b35}.logo-s11{fill:#ffe44d}.logo-s12{fill:#e23d6e}.logo-s13{fill:#c8d6df}
                            </style>
                        </defs>
                        <g class="logo-s7"><g class="logo-s7"><text class="logo-s6" transform="translate(7.8 36.37)"><tspan x="0" y="0">Recolor</tspan></text></g></g>
                        <rect class="logo-s10" x="109.82" y="13.74" width="24.77" height="24.77" rx="5" ry="5"/>
                        <rect class="logo-s0" x="20.02" y="46.77" width="24.77" height="24.77" rx="5" ry="5"/>
                        <rect class="logo-s12" x="49.96" y="46.77" width="24.77" height="24.77" rx="5" ry="5"/>
                        <rect class="logo-s11" x="79.89" y="46.77" width="24.77" height="24.77" rx="5" ry="5"/>
                        <rect class="logo-s2" x="109.82" y="46.77" width="24.77" height="24.77" rx="5" ry="5"/>
                        <line class="logo-s3" x1="139.75" y1="26.12" x2="172.56" y2="26.12"/>
                        <line class="logo-s3" x1="139.75" y1="59.16" x2="172.56" y2="59.16"/>
                        <polygon class="logo-s13" points="164.33 53.07 174.98 59.28 164.33 65.5 164.33 53.07"/>
                        <rect class="logo-s9" x="176.91" y="13.74" width="24.77" height="24.77" rx="5" ry="5"/>
                        <rect class="logo-s1" x="176.91" y="46.77" width="24.77" height="24.77" rx="5" ry="5"/>
                        <g class="logo-s7"><g class="logo-s7"><text class="logo-s5" transform="translate(204.58 36.37)"><tspan x="0" y="0">Preview</tspan></text></g></g>
                        <g class="logo-s7"><g class="logo-s7"><text class="logo-s4" transform="translate(206.67 68.86)"><tspan x="0" y="0">Tool</tspan></text></g></g>
                        <g class="logo-s7"><g class="logo-s7"><text class="logo-s8" transform="translate(20.02 86.01)"><tspan x="0" y="0">Ineptly vibe-coded by David Landerman</tspan></text></g></g>
                        <polygon class="logo-s13" points="164.33 19.91 174.98 26.12 164.33 32.34 164.33 19.91"/>
                    </svg>
                </div>
                <div class="mode-toggle-wrapper" id="modeToggleWrapper">
                    <span class="mode-toggle-label active" id="modeLabelBeginner" onclick="setAppMode('beginner')">Beginner</span>
                    <button class="mode-toggle-switch" id="modeSwitch" onclick="toggleAppMode()" title="Toggle Beginner/Advanced mode">
                        <span class="mode-toggle-knob"></span>
                    </button>
                    <span class="mode-toggle-label active" id="modeLabelAdvanced" onclick="setAppMode('advanced')">Advanced</span>
                </div>
            </div>
            <!-- Progressive instructions: collapsible wrapper -->
            <div class="instructions-wrapper" id="instructionsWrapper">
                <div class="header-controls-row">
                    <button class="instructions-toggle" id="instructionsToggle" onclick="toggleInstructions()">
                        <span class="instructions-toggle-arrow" id="instructionsToggleArrow">‚ñæ</span>
                        <span class="instructions-toggle-label">Instructions</span>
                    </button>
                </div>
                <div class="progressive-instructions" id="progressiveInstructions">
                    <div class="instruction-step active" data-step="initial">
                        <span class="instruction-step-num">1</span>
                        <span class="instruction-step-text">Upload an image to get started. <span class="photo-warning">Won't work for photographs</span></span>
                    </div>
                    <div class="instruction-step" data-step="image-loaded">
                    <span class="instruction-step-num">2</span>
                    <span class="instruction-step-text">Click the <span class="btn-highlight">üéØ Pick Colors</span> button to select Original colors from the image by category (Background, Accent 1, etc). <br>Colors of the same Original Color category will all recolor to look like the same color.</span>
                    <div class="instruction-hints">
                        <span class="instruction-hint instruction-hint-advanced">Use the Color Consolidation slider to merge similar colors. <span class="advanced-tag">(Advanced)</span></span>
                    </div>
                </div>
                <div class="instruction-step" data-step="colors-picked">
                    <span class="instruction-step-num">3</span>
                    <span class="instruction-step-text">Review the color categories below, then click <span class="btn-highlight">üé® Look's Good!</span> to start choosing new colors.</span>
                    <div class="instruction-hints">
                        <span class="instruction-hint">You may want to reorganize them by dragging them to different columns.</span>
                        <span class="instruction-hint">If you forgot to add a color, use the <span class="add-color-icon-box">+</span><span class="add-color-label-faded">Leftover Colors</span> tool in the color bank to add a color that was automatically extracted from the image.</span>
                        <span class="instruction-hint instruction-hint-advanced">Use the <strong><svg class="hint-icon-svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg> Opacity</strong> tool on any original color swatch to differentiate how original colors of the same category apply their new color. <span class="advanced-tag">(Advanced)</span></span>
                    </div>
                </div>
                <!-- Steps 4-6: slideshow in beginner mode, all visible in advanced -->
                <div class="instruction-slides-wrapper" id="instructionSlidesWrapper">
                    <div class="instruction-step instruction-slide" data-step="target-selection" data-slide-index="0">
                        <span class="instruction-step-num" id="targetStepNum">4</span>
                        <span class="instruction-step-text" id="targetStepText">Time to choose your new colors ‚Äî there's LOTS of ways to do this! Hit <span class="btn-highlight">Apply this recolor</span> when you're done, or just turn on <span class="btn-highlight">Recolor Live</span> to have the preview update whenever you make a change.</span>
                        <div class="instruction-hints">
                            <span class="instruction-hint instruction-hint-heading">You're gonna need this</span>
                            <span class="instruction-hint"><strong>üîí Lock/Bypass</strong> ‚Äî keep a column's original colors unchanged. Click the lock icon under each new color swatch. <strong>I recommend locking out your background for good measure.</strong></span>
                            <span class="instruction-hint instruction-hint-heading instruction-hint-fancy">Fancy Stuff</span>
                            <span class="instruction-hint instruction-hint-fancy"><strong><svg class="hint-icon-svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg> Opacity</strong> ‚Äî differentiate how original colors of the same category apply their new color. Click the droplet icon under a new color swatch, or on individual original color swatches in the bucket panel.</span>
                            <span class="instruction-hint instruction-hint-fancy"><strong>‚òÄÔ∏è Luminosity</strong> ‚Äî post-processing brightness adjustment (respects locks).</span>
                            <span class="instruction-hint instruction-hint-fancy"><strong>üîÄ Shuffle</strong> ‚Äî randomize your new color swatches to experiment.</span>
                            <span class="instruction-hint instruction-hint-fancy"><strong>Simple / Advanced</strong> ‚Äî switch between nearest-neighbor and RBF interpolation.</span>
                        </div>
                        <div class="instruction-reassurance">Don't worry about using all the features displayed ‚Äî pick colors, choose new ones, and recolor. The rest is optional polish.</div>
                    </div>
                    <!-- Step 5 (advanced mode shows this) -->
                    <div class="instruction-step instruction-slide instruction-slide-advanced-only" data-step="complete" data-slide-index="1">
                        <span class="instruction-step-num">5</span>
                        <span class="instruction-step-text">Save your recolor.</span>
                        <div class="instruction-hints">
                            <span class="instruction-hint">When you see a recolor you like, hit <span class="btn-highlight">Save Recolor Configuration</span> or go to the History list and hit save next to any of the color configurations you've seen so far. When you're done, hit the export button and all your saved configurations will be recorded on one file. Hold onto that file and your image.</span>
                            <span class="instruction-hint">You can reload your image and the configuration file at any time to pick up where you left off with your saved configurations.</span>
                        </div>
                    </div>
                    <!-- Step 6 (advanced mode shows this) -->
                    <div class="instruction-step instruction-slide instruction-slide-advanced-only" data-step="complete" data-slide-index="2">
                        <span class="instruction-step-num">6</span>
                        <span class="instruction-step-text">Download your recolored image!</span>
                    </div>
                    <!-- Combined step 5/6 (beginner mode slideshow only) -->
                    <div class="instruction-step instruction-slide instruction-slide-beginner-only" data-step="complete" data-slide-index="1">
                        <span class="instruction-step-num">5/6</span>
                        <span class="instruction-step-text">Save your recolor / Download your recolored image!</span>
                        <div class="instruction-hints">
                            <span class="instruction-hint">When you see a recolor you like, hit <span class="btn-highlight">Save Recolor Configuration</span> or go to the History list and hit save next to any of the color configurations you've seen so far. When you're done, hit the export button and all your saved configurations will be recorded on one file. Hold onto that file and your image.</span>
                            <span class="instruction-hint">You can reload your image and the configuration file at any time to pick up where you left off with your saved configurations.</span>
                            <span class="instruction-hint">Hit the <span class="btn-download-inline">Download Recolored Image</span> button to save your image.</span>
                        </div>
                    </div>
                    <!-- Slide navigation (beginner mode only) -->
                    <div class="instruction-slide-nav" id="instructionSlideNav">
                        <button class="instruction-slide-prev" id="instrSlidePrev" onclick="changeInstructionSlide(-1)">‚Üê Prev</button>
                        <span class="instruction-slide-indicator" id="instrSlideIndicator">Step 4</span>
                        <button class="instruction-slide-next" id="instrSlideNext" onclick="changeInstructionSlide(1)">Next ‚Üí</button>
                    </div>
                </div>
            </div>
            </div>
        </header>

        <div class="workspace" id="workspace">
            <!-- ============================== -->
            <!-- IMAGE PREVIEW BOX              -->
            <!-- ============================== -->
            <div class="canvas-area" id="canvasArea">
                <div class="canvas-header">
                    <!-- Algorithm toggle MOVED to Target Choice box -->
                    <!-- Reset/Remove buttons moved below image preview -->
                </div>
                <!-- Resize handles (hidden until image loaded) -->
                <div class="resize-handle resize-handle-right hidden" id="resizeRight"></div>
                <div class="resize-handle resize-handle-bottom hidden" id="resizeBottom"></div>
                <div class="resize-handle resize-handle-corner hidden" id="resizeCorner"></div>

                <!-- Color tolerance and color strips MOVED to Color Analysis box -->

                <!-- Tutorial panel for color picker (sits above canvas, pushes image down) -->
                <div class="tutorial-panel hidden" id="tutorialOverlay">
                    <div class="tutorial-content">
                        <div class="tutorial-left">
                            <div class="tutorial-text" id="tutorialText"></div>
                            <div class="tutorial-hints">
                                <!-- <span class="tutorial-hint-item tutorial-shift-hint">Double-tap Shift to advance to the next color category</span> -->
                                <!-- <span class="tutorial-hint-item">When zoomed: Hold ‚å• + drag to explore</span> -->
                            </div>
                        </div>
                        <div class="tutorial-right" id="tutorialRight">
                            <!-- Populated by JS: shift hint, picking-for, swatches, clear, orange-label hint -->
                        </div>
                    </div>
                    <div class="tutorial-bottom-row">
                        <div class="tutorial-bottom-left">
                            <button class="tutorial-hide-btn" id="tutorialHideBtn" onclick="collapseTutorial()">Hide Tutorial</button>
                            <!-- <span class="tutorial-hint-item tutorial-ctrl-hint">Hit Ctrl to temporarily hide</span> -->
                        </div>
                        <div class="tutorial-buttons-right">
                            <button class="tutorial-finish-btn hidden" id="tutorialFinishBtn" onclick="applyPickedAsOriginal()">That's all my colors, let's move on!</button>
                            <button class="tutorial-next-btn" id="tutorialNextBtn" onclick="tutorialNextStep()">Next Color</button>
                        </div>
                    </div>
                </div>
                <div class="canvas-wrapper" id="canvasWrapper">
                    <!-- Tutorial collapsed tab ‚Äî absolutely positioned, hangs down from top edge -->
                    <div class="tutorial-tab hidden" id="tutorialTab" onclick="expandTutorial()">Tutorial</div>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <div class="step-circle">1</div>
                        <div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
                        <div class="upload-text">Click to upload an image</div>
                        <div class="upload-hint">PNG, JPG, WebP, SVG, GIF</div>
                    </div>
                    <div class="canvas-inner" id="canvasInner">
                        <canvas id="imageCanvas"></canvas>
                    </div>
                    <div class="loading-overlay hidden" id="loadingOverlay">
                        <div class="spinner"></div>
                    </div>
                    <!-- Floating tools column: zoom + harmony, positioned together -->
                    <div class="canvas-tools-column" id="canvasToolsColumn">
                        <div class="zoom-slider-container hidden" id="zoomSliderContainer">
                            <div class="zoom-hint-note">Hold ‚å• + Scroll</div>
                            <span class="zoom-value-display" id="zoomValueDisplay">100%</span>
                            <input type="range" class="zoom-slider-vertical" id="zoomSlider"
                                   min="100" max="400" value="100"
                                   oninput="setZoomFromSlider(this.value)">
                            <span class="zoom-slider-label">ZOOM</span>
                        </div>
                        <div class="quick-harmony-overlay hidden" id="quickHarmonyBar">
                            <div class="quick-harmony-overlay-panel" id="quickHarmonyPanel">
                                <div class="quick-harmony-overlay-header">
                                    <span class="quick-harmony-overlay-title">Color Harmony</span>
                                    <button class="quick-harmony-collapse-btn" onclick="toggleQuickHarmonyCollapse()" title="Collapse">‚úï</button>
                                </div>
                                <div class="quick-harmony-mode-toggle">
                                    <span class="quick-harmony-mode-label active" id="quickModeHarmonyLabel" onclick="setHarmonyMode('harmony')">Harmony</span>
                                    <div class="quick-harmony-mode-switch" id="quickModeSwitch" onclick="toggleHarmonyMode()"></div>
                                    <span class="quick-harmony-mode-label" id="quickModeColorLabel" onclick="setHarmonyMode('color')">Color</span>
                                </div>
                                <div class="quick-harmony-controls-wrapper">
                                    <!-- Lock a Harmony controls -->
                                    <div class="quick-harmony-controls" id="quickHarmonyControls">
                                        <select class="quick-harmony-select" id="quickHarmonyType" onchange="syncHarmonySelects(this.value)">
                                            <option value="complementary">Complementary</option>
                                            <option value="analogous">Analogous</option>
                                            <option value="triadic">Triadic</option>
                                            <option value="split">Split-Comp</option>
                                            <option value="tetradic">Tetradic</option>
                                        </select>
                                        <button class="btn btn-small quick-harmony-btn" onclick="quickRandomizeHarmony()" title="Random base hue + selected harmony">üé≤ Randomize</button>
                                        <button class="btn btn-small quick-harmony-btn" onclick="quickGenerateHarmony()" title="Generate from slider settings">üé® Generate</button>
                                    </div>
                                    <!-- Lock a Color controls -->
                                    <div class="quick-harmony-controls hidden" id="quickColorControls">
                                        <div class="quick-lock-color-select-wrapper" id="quickLockColorSelectWrapper"></div>
                                        <button class="btn btn-small quick-harmony-btn" onclick="randomizeLockColor()" title="Randomize around locked color">üé≤ Randomize</button>
                                        <button class="btn btn-small quick-harmony-btn" onclick="harmonizePalette()" title="Nudge existing new colors toward harmony of selected color">‚Üó Nudge <span class="harmony-nudge-swatch" id="quickNudgeSwatch" title="Based on selected locked color"></span></button>
                                        <select class="quick-harmony-select" id="quickLockColorHarmonyType" onchange="syncHarmonySelects(this.value)" style="font-size: 0.6rem; padding: 0.15rem 0.2rem; max-width: 95px;">
                                            <option value="complementary">Compl.</option>
                                            <option value="analogous">Analog.</option>
                                            <option value="triadic">Triadic</option>
                                            <option value="split">Split-C</option>
                                            <option value="tetradic">Tetrad.</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="quick-harmony-result hidden" id="quickHarmonyResult"></div>
                            </div>
                            <!-- Collapsed tab (color wheel icon) -->
                            <button class="quick-harmony-tab hidden" id="quickHarmonyTab" onclick="toggleQuickHarmonyCollapse()" title="Color Harmony">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="9"/>
                                    <circle cx="12" cy="5.5" r="2.2" fill="#e74c3c" stroke="none"/>
                                    <circle cx="17.6" cy="9.5" r="2.2" fill="#f39c12" stroke="none"/>
                                    <circle cx="16" cy="16" r="2.2" fill="#2ecc71" stroke="none"/>
                                    <circle cx="8" cy="16" r="2.2" fill="#3498db" stroke="none"/>
                                    <circle cx="6.4" cy="9.5" r="2.2" fill="#9b59b6" stroke="none"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Picker overlay -->
                    <div class="picker-overlay hidden" id="pickerOverlay">
                        <button class="picker-toggle-btn" id="pickerToggleBtn" onclick="togglePickerMode()">
                            <span>üéØ</span>
                            <span class="picker-toggle-text">Pick Colors</span>
                        </button>
                        <div class="picker-category-selector hidden" id="pickerCategorySelector">
                            <span class="picker-category-label">Picking for:</span>
                            <select id="pickerCategorySelect" onchange="handlePickerCategoryChange(this.value)">
                                <!-- Options populated dynamically -->
                            </select>
                        </div>
                        <div class="picker-swatches-list hidden" id="pickerSwatchesList"></div>
                        <button class="picker-apply-btn hidden" id="pickerApplyBtn" onclick="applyPickedAsOriginal()" disabled>
                            All done
                        </button>
                        <button class="picker-clear-btn hidden" id="pickerClearBtn" onclick="clearPickerSelections()">
                            Clear Selections
                        </button>
                        <!-- Hints shown when picker is active -->
                        <div class="picker-pan-hint hidden" id="pickerPanHint">When Zoomed: Hold ‚å• + drag to explore</div>
                        <div class="picker-pan-hint hidden" id="pickerCtrlHint">Hit Ctrl to temporarily hide this menu</div>
                    </div>

                    <div class="zoom-controls hidden" id="zoomControls">
                        <button class="zoom-btn zoom-btn-wide" onclick="resetZoom()" title="Reset View"><span class="reset-view-icon">‚ü≤</span> Reset View</button>
                    </div>
                    <div class="pan-hint" id="panHint">Alt+Drag to pan ‚Ä¢ Alt+Scroll to zoom</div>
                </div>
                <!-- Demo Image button ‚Äî positioned outside canvas-wrapper so it's not clipped by overflow:hidden -->
                <button class="btn btn-demo-striped btn-demo-image" id="demoImageBtn" onclick="loadDemoImage()"><span class="demo-label">üé® See an Example</span></button>
                <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">

                <!-- Keyboard hints + action buttons in one row -->
                <div class="image-action-row hidden" id="imageButtonGroup">
                    <div class="keyboard-hints hidden" id="keyboardHints">
                        <div class="key-hint" id="keyHintOption"><div class="key-stack"><span class="key-action">Hold</span><kbd>Option</kbd></div><span>Scroll to zoom<br>Drag to pan</span></div>
                        <div class="key-hint picker-only-hint" id="keyHintCtrl"><div class="key-stack"><span class="key-action">Tap</span><kbd>Ctrl</kbd></div><span>Toggle overlay<br>visibility</span></div>
                        <div class="key-hint picker-only-hint" id="keyHintShift"><div class="key-stack"><span class="key-action">Double-tap</span><kbd>Shift</kbd></div><span>Switch to next<br>color category</span></div>
                    </div>
                    <div class="image-action-buttons">
                        <button class="btn" onclick="resetImage()">Reset Recolor</button>
                        <button class="btn" onclick="removeImage()" title="Remove image and start fresh">Remove Image</button>
                    </div>
                </div>

                <!-- Tool Legend (shown when target choice appears) -->
                <div class="tool-legend-panel hidden" id="toolLegendPanel">
                    <div class="tool-legend-title">Tool Reference</div>
                    <div class="tool-legend-grid">
                        <div class="tool-legend-item">
                            <span class="tool-legend-emoji">üé®</span>
                            <span class="tool-legend-desc"><strong>Color Picker</strong> ‚Äî Opens a manual color picker to set the new color</span>
                        </div>
                        <div class="tool-legend-item">
                            <span class="tool-legend-emoji">üîí</span>
                            <span class="tool-legend-desc"><strong>Lock/Bypass</strong> ‚Äî Keeps original colors unchanged through the recolor</span>
                        </div>
                        <div class="tool-legend-item">
                            <span class="tool-legend-emoji">üîÄ</span>
                            <span class="tool-legend-desc"><strong>Shuffle</strong> ‚Äî Randomizes the order of the new color swatches</span>
                        </div>
                        <div class="tool-legend-item">
                            <span class="tool-legend-emoji">‚ü≤</span>
                            <span class="tool-legend-desc"><strong>Reset View</strong> ‚Äî Resets zoom, pan, and image viewing area height</span>
                        </div>
                        <div class="tool-legend-divider"></div>
                        <div class="tool-legend-subtitle">Fancy Stuff</div>
                        <div class="tool-legend-item">
                            <span class="tool-legend-emoji"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg></span>
                            <span class="tool-legend-desc"><strong>Opacity</strong> ‚Äî Differentiate how original colors of the same category apply their new color. Click the droplet icon under a new color swatch, or on individual original color swatches.</span>
                        </div>
                        <div class="tool-legend-item">
                            <span class="tool-legend-emoji">‚òÄÔ∏è</span>
                            <span class="tool-legend-desc"><strong>Luminosity</strong> ‚Äî Post-processing brightness adjustment (respects locks)</span>
                        </div>
                        <div class="tool-legend-item">
                            <span class="tool-legend-emoji">‚öôÔ∏è</span>
                            <span class="tool-legend-desc"><strong>Simple / Advanced</strong> ‚Äî Switch between nearest-neighbor and RBF interpolation algorithms</span>
                        </div>
                    </div>
                </div>

                <!-- Debug Console (always visible in advanced mode) -->
                <div class="debug-console collapsed" id="debugConsole">
                    <div class="debug-console-header" onclick="toggleDebugConsole()">
                        <span class="debug-console-title">Render Log</span>
                        <div class="debug-console-controls">
                            <button class="debug-btn debug-btn-record" id="debugRecordBtn" onclick="event.stopPropagation(); toggleDebugRecording()" title="Paused"><span class="record-dot">&#9679;</span> Record</button>
                            <button class="debug-btn debug-btn-eyedropper" id="debugEyedropperBtn" onclick="event.stopPropagation(); toggleDebugEyedropper()" title="Eyedropper ‚Äî click image to sample pixel info">&#128269; Probe</button>
                            <button class="debug-btn debug-btn-clear" id="debugInspectBtn" onclick="event.stopPropagation(); toggleDebugInspect()" title="Click any element to dump its state">Inspect</button>
                            <button class="debug-btn debug-btn-clear" onclick="event.stopPropagation(); dumpAppState()" title="Dump app state + layout to log">State</button>
                            <button class="debug-btn debug-btn-clear" onclick="event.stopPropagation(); addDebugMark()" title="Add a numbered marker to the log">Mark</button>
                            <button class="debug-btn debug-btn-clear" onclick="event.stopPropagation(); clearDebugLog()" title="Clear log">Clear</button>
                            <button class="debug-btn debug-btn-copy" onclick="event.stopPropagation(); copyDebugLog()" title="Copy log">Copy</button>
                            <span class="debug-collapse-arrow" id="debugCollapseArrow">&#9660;</span>
                        </div>
                    </div>
                    <div class="debug-console-body" id="debugConsoleBody"><div class="log-entry"><span class="log-time">[‚Äî]</span> <span class="log-info">Waiting for render...</span></div></div>
                </div>
            </div>

            <!-- ============================== -->
            <!-- SIDEBAR (hidden until image)   -->
            <!-- ============================== -->
            <div class="sidebar hidden" id="sidebar">

                <!-- ============================== -->
                <!-- COLOR ANALYSIS BOX             -->
                <!-- ============================== -->
                <div class="panel" id="colorAnalysisPanel">
                    <!-- Pick Colors button at top -->
                    <button class="btn btn-primary btn-full pick-colors-sidebar-btn btn-with-step" id="sidebarPickColorsBtn" onclick="togglePickerMode()">
                        <span class="step-circle step-circle-btn">2</span>
                        <span>üéØ</span> Pick Colors
                    </button>
                    <div class="pick-colors-description-wrapper" id="pickerInstructions" style="display:none;">
                    </div>

                    <!-- Import config shortcut (hidden once Target Choice panel reveals full config) -->
                    <div class="early-import-section" id="earlyImportSection">
                        <button class="btn btn-subtle" onclick="document.getElementById('earlyConfigFileInput').click()">
                            üìÅ Import Saved Configuration
                        </button>
                        <input type="file" id="earlyConfigFileInput" accept=".json" style="display:none" onchange="importConfigFileEarly(event)">
                    </div>
                    <!-- Demo config import (visible only when demo image is loaded) -->
                    <div class="demo-import-section hidden" id="demoImportSection">
                        <button class="btn btn-demo-striped btn-demo-config" onclick="loadDemoConfig()"><span class="demo-label">üé® Import Demo Configuration</span></button>
                    </div>
                </div>

                <!-- ============================== -->
                <!-- COLOR ANALYSIS (OPTIONAL) BOX  -->
                <!-- ============================== -->
                <details class="panel hidden color-analysis-collapsible" id="colorAnalysisOptionalPanel" open>
                    <summary class="panel-title color-analysis-summary">Color Analysis <span class="tolerance-optional">(OPTIONAL)</span></summary>

                    <div class="color-analysis-body">
                        <!-- Color distribution strips -->
                        <div class="color-strip-container" id="colorStripContainer">
                            <div class="color-strip-header">
                                <span class="color-strip-label">Original Distribution</span>
                                <label class="descale-checkbox">
                                    <input type="checkbox" id="descaleBgCheckbox" onchange="renderColorStrip()">
                                    <span>Descale Background on Distribution</span>
                                </label>
                            </div>
                            <div class="color-strip" id="colorStrip"></div>
                            <div class="color-strip-header recolored-header">
                                <span class="color-strip-label">Recolored Distribution</span>
                            </div>
                            <div class="color-strip recolored-strip grayed-out" id="recoloredStrip"></div>
                        </div>

                        <!-- Color Consolidation tool -->
                        <div class="tolerance-container" id="toleranceContainer">
                            <div class="tolerance-header">
                                <span class="tolerance-label-main">Color Consolidation <span class="tolerance-optional">(optional)</span></span>
                                <div class="tolerance-sublabel">Increase this to combine similar colors in the analysis</div>
                            </div>
                            <div class="tolerance-slider-row">
                                <input type="range" class="slider" id="toleranceSlider" min="0" max="50" value="0">
                                <span class="tolerance-value" id="toleranceValue">0</span>
                            </div>
                            <div class="tolerance-controls">
                                <button class="btn btn-small" onclick="resetTolerance()">Default</button>
                                <button class="btn btn-small" id="toleranceApplyBtn" onclick="reExtractWithTolerance()">Apply</button>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- ============================== -->
                <!-- PALETTE MAPPING BOX            -->
                <!-- ============================== -->
                <div class="panel hidden" id="paletteMappingPanel">
                    <div class="panel-title">Review Color Bucketing</div>

                    <!-- Column-based mapping area -->
                    <div class="column-mapping-container" id="columnMappingContainer">
                        <!-- Collapsible Origin section -->
                        <details class="target-tool-section origin-collapsible" id="originCollapsible" open>
                            <summary class="target-tool-summary">üé® Original Colors</summary>
                            <div class="target-tool-content origin-collapsible-content">
                                <div class="origin-drag-hint">Drag to reorganize (optional)</div>
                                <!-- Overflow bank for locked/extra origins -->
                                <div class="origin-overflow-bank" id="originOverflowBank">
                                    <div class="overflow-bank-title">üîí Color Bank</div>
                                    <div class="overflow-origins-grid" id="overflowOriginsGrid"></div>
                                </div>
                                <div class="mapping-columns" id="mappingColumns">
                                    <!-- Columns will be rendered here -->
                                </div>
                            </div>
                        </details>
                        <!-- Targets row (always visible, outside collapsible) -->
                        <div class="mapping-targets-row" id="mappingTargetsRow">
                            <!-- Target swatches will be rendered here -->
                        </div>
                    </div>

                    <!-- Target count control (hidden until target selection stage) -->
                    <div class="palette-row" id="targetControlRow">
                        <span class="palette-row-label">New Colors</span>
                        <button class="btn btn-icon btn-small hidden" id="shuffleBtn" onclick="shuffleTargetPalette()" title="Shuffle target colors">üîÄ</button>
                        <div style="flex:1"></div>
                        <div class="palette-count-control">
                            <button class="palette-count-btn" onclick="changeTargetCount(-1)">‚àí</button>
                            <input type="text" id="targetCountDisplay" value="5" readonly>
                            <button class="palette-count-btn" onclick="changeTargetCount(1)">+</button>
                        </div>
                    </div>

                    <!-- Color Gradient Picker (COMMENTED OUT - redundant with per-swatch pickers) -->
                    <!--
                    <div class="color-picker-area" id="mainGradientPicker">
                        <div class="color-gradient-container" id="colorGradientContainer">
                            <div class="color-gradient-sv" id="colorGradientSV">
                                <div class="color-gradient-white"></div>
                                <div class="color-gradient-black"></div>
                                <div class="color-gradient-cursor" id="colorGradientCursor"></div>
                            </div>
                        </div>
                        <input type="range" class="color-hue-slider" id="colorHueSlider"
                               min="0" max="360" value="0"
                               oninput="updateGradientHue(this.value)">
                    </div>

                    <div class="hex-input-row">
                        <input type="text" class="hex-input" id="hexInput" placeholder="#FF5733" maxlength="7">
                        <div class="color-preview-small" id="hexPreview"></div>
                        <button class="btn" onclick="applyHexToSelected()">Set</button>
                    </div>
                    -->
                    <!-- Keep hidden inputs for JS that may reference them -->
                    <div style="display:none">
                        <div id="colorGradientContainer"><div id="colorGradientSV"><div class="color-gradient-cursor" id="colorGradientCursor"></div></div></div>
                        <input id="colorHueSlider" type="range" min="0" max="360" value="0">
                        <input type="text" id="hexInput" placeholder="#FF5733" maxlength="7">
                        <div id="hexPreview"></div>
                    </div>

                    <!-- Harmony, Luminosity, Config MOVED to Target Choice box -->
                </div>

                <!-- Target Selector Button (between Palette Mapping and Target Choice) -->
                <button class="btn btn-primary btn-full btn-large btn-with-step hidden" id="targetSelectorBtn" onclick="activateTargetSelection()">
                    <span class="step-circle step-circle-btn">3</span>
                    Look's Good!
                </button>

                <!-- ============================== -->
                <!-- TARGET CHOICE BOX              -->
                <!-- ============================== -->
                <div class="panel hidden" id="targetChoicePanel">
                    <div class="panel-title">Pick your new colors</div>

                    <div class="target-choice-description">
                        Choose your new colors manually above or use the tools below.
                    </div>

                    <!-- Direct Color Picker section removed ‚Äî palette icons now always visible after Looks Good -->

                    <!-- I. Theme Presets (collapsible) -->
                    <details class="target-tool-section">
                        <summary class="target-tool-summary">üñºÔ∏è Theme Presets (for exploring and ideas)</summary>
                        <div class="target-tool-content">
                            <div class="theme-section">
                                <div class="theme-scroll-container" id="themeScrollContainer"></div>
                            </div>
                        </div>
                    </details>

                    <!-- II. Color Harmony (collapsible) -->
                    <details class="target-tool-section">
                        <summary class="target-tool-summary"><svg class="tool-summary-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="5.5" r="2.2" fill="#e74c3c" stroke="none"/><circle cx="17.6" cy="9.5" r="2.2" fill="#f39c12" stroke="none"/><circle cx="16" cy="16" r="2.2" fill="#2ecc71" stroke="none"/><circle cx="8" cy="16" r="2.2" fill="#3498db" stroke="none"/><circle cx="6.4" cy="9.5" r="2.2" fill="#9b59b6" stroke="none"/></svg> Use custom Color Harmonies!</summary>
                        <div class="target-tool-content">
                            <div class="harmony-section">
                                <!-- Mode toggle: Lock a Harmony / Lock a Color -->
                                <div class="harmony-mode-toggle">
                                    <span class="harmony-mode-label active" id="harmonyModeHarmonyLabel" onclick="setHarmonyMode('harmony')">Lock a Harmony</span>
                                    <div class="harmony-mode-switch" id="harmonyModeSwitch" onclick="toggleHarmonyMode()"></div>
                                    <span class="harmony-mode-label" id="harmonyModeColorLabel" onclick="setHarmonyMode('color')">Lock a Color</span>
                                </div>

                                <!-- Lock a Harmony panel (default) -->
                                <div class="harmony-mode-panel" id="harmonyPanelHarmony">
                                    <div style="font-size: 0.6rem; color: var(--text-muted); margin-bottom: 0.4rem; font-style: italic;">
                                        Generate a new palette following the selected harmony rule
                                    </div>
                                    <div class="harmony-row">
                                        <select class="harmony-select" id="harmonyType" onchange="syncHarmonySelects(this.value); updateHarmonyWheel();">
                                            <option value="complementary">Complementary</option>
                                            <option value="analogous">Analogous</option>
                                            <option value="triadic">Triadic</option>
                                            <option value="split">Split-Complementary</option>
                                            <option value="tetradic">Tetradic (Square)</option>
                                        </select>
                                    </div>

                                    <!-- Hue offset slider -->
                                    <div class="harmony-control-row">
                                        <span class="harmony-control-label">Base Hue</span>
                                        <input type="range" class="harmony-hue-slider" id="harmonyBaseHue" min="0" max="360" value="180"
                                               oninput="updateHarmonyBaseHueDisplay(this.value); updateHarmonyPreview()">
                                        <span class="harmony-control-value" id="harmonyBaseHueValue">180¬∞</span>
                                    </div>

                                    <!-- Brightness slider -->
                                    <div class="harmony-control-row">
                                        <span class="harmony-control-label">Brightness</span>
                                        <input type="range" class="harmony-brightness-slider" id="harmonyBrightness" min="0" max="100" value="50"
                                               oninput="updateHarmonyBrightnessDisplay(this.value); updateHarmonyPreview()">
                                        <span class="harmony-control-value" id="harmonyBrightnessValue">50</span>
                                    </div>

                                    <!-- Base slot picker -->
                                    <div class="harmony-base-picker" id="harmonyBasePicker">
                                        <span class="harmony-base-picker-label">Base color slot:</span>
                                        <div class="harmony-base-picker-list" id="harmonyBasePickerList">
                                            <!-- Populated dynamically: one item per target column -->
                                        </div>
                                    </div>

                                    <!-- Live preview strip -->
                                    <div class="harmony-preview-strip" id="harmonyPreviewStrip">
                                        <!-- Populated dynamically -->
                                    </div>

                                    <!-- Include locked colors toggle -->
                                    <label class="harmony-include-locked-label" id="harmonyIncludeLockedRow">
                                        <input type="checkbox" id="harmonyIncludeLocked" onchange="toggleHarmonyIncludeLocked()">
                                        <span>Consider locked colors on wheel</span>
                                    </label>

                                    <div class="harmony-btn-row">
                                        <button class="btn btn-randomize-harmony harmony-btn-half" onclick="randomizeHarmony()" id="harmonyRandomizeBtn">üé≤ Randomize within <span id="harmonyRandomizeLabel">Complementary</span></button>
                                        <button class="btn btn-randomize-harmony harmony-btn-half" onclick="generateHarmonyFromControls()">üé® Generate Palette based on selections</button>
                                    </div>

                                    <!-- Harmony Tutorial -->
                                    <details class="harmony-tutorial" id="harmonyTutorial">
                                        <summary class="harmony-tutorial-summary">How does this work?</summary>
                                        <div class="harmony-tutorial-slides" id="harmonyTutorialSlides">
                                            <div class="harmony-tutorial-slide active" data-slide="0">
                                                <div class="harmony-tutorial-slide-number">1 / 5</div>
                                                <div class="harmony-tutorial-slide-title">Two Modes</div>
                                                <div class="harmony-tutorial-slide-body">
                                                    The toggle at the top switches between two modes:<br><br>
                                                    <b>Lock a Harmony</b> &mdash; You control the harmony type and parameters. The tool generates new colors to follow that harmony rule.<br><br>
                                                    <b>Lock a Color</b> &mdash; You pick one color to keep fixed. Randomize generates other colors around it. Nudge shifts your existing colors toward harmony with it.
                                                </div>
                                            </div>
                                            <div class="harmony-tutorial-slide" data-slide="1">
                                                <div class="harmony-tutorial-slide-number">2 / 5</div>
                                                <div class="harmony-tutorial-slide-title">Harmony Types</div>
                                                <div class="harmony-tutorial-slide-body">
                                                    The dropdown selects which color relationship to use:<br><br>
                                                    <b>Complementary</b> &mdash; Opposite sides of the wheel (180&deg; apart). High contrast.<br>
                                                    <b>Analogous</b> &mdash; Neighboring hues (30&deg; apart). Smooth, cohesive.<br>
                                                    <b>Triadic</b> &mdash; Three evenly spaced (120&deg;). Vibrant, balanced.<br>
                                                    <b>Split-Complementary</b> &mdash; Base + two neighbors of its complement.<br>
                                                    <b>Tetradic</b> &mdash; Four colors at 90&deg; intervals. Rich, complex.
                                                </div>
                                            </div>
                                            <div class="harmony-tutorial-slide" data-slide="2">
                                                <div class="harmony-tutorial-slide-number">3 / 5</div>
                                                <div class="harmony-tutorial-slide-title">The Controls</div>
                                                <div class="harmony-tutorial-slide-body">
                                                    <b>Base Hue</b> &mdash; The starting angle on the color wheel. This is the anchor color; other colors are placed around it based on the harmony type.<br><br>
                                                    <b>Brightness</b> &mdash; How light or dark the generated colors are. The tool adds a small amount of variation so colors aren't all identical.
                                                </div>
                                            </div>
                                            <div class="harmony-tutorial-slide" data-slide="3">
                                                <div class="harmony-tutorial-slide-number">4 / 5</div>
                                                <div class="harmony-tutorial-slide-title">The Buttons</div>
                                                <div class="harmony-tutorial-slide-body">
                                                    <b>Lock a Harmony</b> side:<br>
                                                    <b>Generate Palette</b> &mdash; Creates colors using your chosen harmony type, base hue, and brightness.<br>
                                                    <b>Randomize</b> &mdash; Ignores the sliders and generates a fully random palette within the selected harmony.<br><br>
                                                    <b>Lock a Color</b> side:<br>
                                                    <b>Randomize</b> &mdash; Picks a random harmony and generates colors around your locked color.<br>
                                                    <b>Nudge</b> &mdash; Shifts existing new colors toward harmony with your locked color. Preserves each color's saturation and lightness.
                                                </div>
                                            </div>
                                            <div class="harmony-tutorial-slide" data-slide="4">
                                                <div class="harmony-tutorial-slide-number">5 / 5</div>
                                                <div class="harmony-tutorial-slide-title">Locked Colors</div>
                                                <div class="harmony-tutorial-slide-body">
                                                    Any new color swatch with the lock engaged is <b>skipped</b> by all three buttons. This lets you protect colors you like while regenerating the rest.<br><br>
                                                    The color wheel below shows where your current new colors sit. Harmony patterns will appear as evenly-spaced dots around the wheel.
                                                </div>
                                            </div>
                                            <div class="harmony-tutorial-nav">
                                                <button class="harmony-tutorial-prev" id="harmonyTutorialPrev" onclick="harmonyTutorialNav(-1)">&larr; Prev</button>
                                                <button class="harmony-tutorial-next" id="harmonyTutorialNext" onclick="harmonyTutorialNav(1)">Next &rarr;</button>
                                            </div>
                                        </div>
                                    </details>
                                </div>

                                <!-- Lock a Color panel (hidden by default) -->
                                <div class="harmony-mode-panel hidden" id="harmonyPanelColor">
                                    <div style="font-size: 0.6rem; color: var(--text-muted); margin-bottom: 0.4rem; font-style: italic;">
                                        Lock one new color and generate compatible colors around it
                                    </div>
                                    <div class="lock-color-swatch-picker" id="lockColorSwatchPicker">
                                        <!-- Populated dynamically with swatch-style color options -->
                                    </div>
                                    <button class="btn btn-full btn-randomize-harmony" onclick="randomizeLockColor()">üé≤ Randomize Around Locked Color</button>
                                    <div class="harmony-nudge-row" style="margin-top: 0.4rem;">
                                        <div style="display: flex; align-items: center; gap: 0.35rem;">
                                            <button class="btn btn-full harmony-nudge-btn" onclick="harmonizePalette()" style="flex: 1;">
                                                <span>‚Üó Nudge to</span>
                                                <span class="harmony-nudge-swatch" id="harmonyNudgeSwatch" title="Based on selected locked color"></span>
                                            </button>
                                            <select class="quick-harmony-select" id="lockColorHarmonyType" onchange="syncHarmonySelects(this.value)" style="flex: 0 0 auto; font-size: 0.65rem; padding: 0.25rem;">
                                                <option value="complementary">Complementary</option>
                                                <option value="analogous">Analogous</option>
                                                <option value="triadic">Triadic</option>
                                                <option value="split">Split-Comp</option>
                                                <option value="tetradic">Tetradic</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="lock-color-result-label hidden" id="lockColorResultLabel">
                                        <!-- Shows which harmony was selected after randomize -->
                                    </div>
                                </div>

                                <div class="harmony-nudge-hint" id="harmonyNudgeHint">Select a new color for Nudge: click a dot on the wheel or a new color swatch above</div>
                                <div class="harmony-wheel-container">
                                    <canvas id="harmonyWheelCanvas" width="100" height="100"></canvas>
                                </div>
                                <button class="btn btn-full btn-activate-minitool" id="activateMiniToolBtn" onclick="activateHarmonyMiniTool()">üé® Activate Mini-tool!</button>
                            </div>
                        </div>
                    </details>

                    <!-- III. Import Theme From Adobe Color (collapsible) -->
                    <details class="target-tool-section">
                        <summary class="target-tool-summary"><img class="tool-summary-icon" src="https://cdn-icons-png.flaticon.com/128/5436/5436922.png" width="16" height="16" alt="Adobe"> Import a theme from Adobe Color</summary>
                        <div class="target-tool-content">
                            <div class="adobe-section">
                                <a class="adobe-color-link-top" href="https://color.adobe.com/create/color-wheel" target="_blank" rel="noopener noreferrer">Open Adobe Color ‚Üí</a>
                                <details class="adobe-instructions">
                                    <summary>How to get CSS from Adobe Color</summary>
                                    <div class="adobe-instructions-content">
                                        <ol>
                                            <li><a href="https://color.adobe.com/create/color-wheel" target="_blank" rel="noopener noreferrer">Open Adobe Color ‚Üí</a></li>
                                            <li>Create or choose a theme</li>
                                            <li>Save it to your library</li>
                                            <li>Open the <strong>Libraries</strong> tab at the top</li>
                                            <li>Find your theme, click <strong>‚ãØ</strong> ‚Üí <strong>Copy as CSS</strong></li>
                                            <li>Paste below</li>
                                        </ol>
                                    </div>
                                </details>
                                <textarea class="adobe-textarea" id="adobeInput"
                                          placeholder="Paste CSS from color.adobe.com"
                                          oninput="previewAdobeColors(this.value)"></textarea>
                                <div class="import-preview hidden" id="importPreview">
                                    <span class="import-label">Preview:</span>
                                    <div class="import-colors" id="importColors"></div>
                                </div>
                                <button class="btn btn-full" onclick="importAdobePalette()">Import Palette</button>
                            </div>
                        </div>
                    </details>

                    <!-- Apply Recolor Button -->
                    <div class="apply-recolor-group" style="margin: 0.75rem 0;">
                        <button class="btn btn-primary btn-full btn-with-step" id="applyRecolorBtn" onclick="applyRecolor()">
                            <span class="step-circle step-circle-btn">4</span>
                            <span id="applyRecolorText">Apply this recolor</span>
                        </button>
                        <label class="live-preview-toggle-below hidden" id="livePreviewToggleWrapper" title="Enable live preview updates">
                            <input type="checkbox" id="livePreviewToggle" onchange="toggleLivePreview(this.checked)">
                            <span class="live-preview-label"><span class="step-circle step-circle-btn live-step-num" style="display:none;">4</span> Recolor Live</span>
                        </label>
                    </div>

                    <div class="divider"></div>

                    <!-- Color Adjust box (algorithm toggle + luminosity) -->
                    <div class="color-adjust-box">
                        <span class="color-adjust-box-title">Color Adjust <span class="tolerance-optional">(optional)</span></span>

                        <!-- Algorithm toggle (Simple / Advanced) -->
                        <div class="algorithm-toggle-bottom">
                            <span class="algorithm-toggle-sublabel">Recolor algorithm</span>
                        </div>
                        <div class="algorithm-toggle-bottom" style="margin-top: 0;">
                            <span class="algorithm-toggle-label" id="algoLabelSimple" onclick="setAlgorithm('simple')">Simple</span>
                            <div class="algorithm-toggle-switch" id="algoSwitch" onclick="toggleAlgorithm()" title="Toggle recolor algorithm"></div>
                            <span class="algorithm-toggle-label" id="algoLabelRBF" onclick="setAlgorithm('rbf')">Advanced</span>
                        </div>

                        <!-- Color Luminosity (Post Processing) -->
                        <details class="target-tool-section" style="margin-top: 0.75rem;">
                            <summary class="target-tool-summary">‚òÄÔ∏è Color Luminosity (Post Processing)</summary>
                            <div class="target-tool-content">
                                <div style="font-size: 0.6rem; color: var(--text-muted); margin-bottom: 0.4rem; font-style: italic;">
                                    Adjusts brightness after recolor. Respects locked colors.
                                </div>
                                <div class="slider-row">
                                    <div class="slider-label">
                                        <span>Brightness Adjustment</span>
                                        <span class="slider-value" id="luminosityValue">0</span>
                                    </div>
                                    <input type="range" class="slider" id="luminositySlider" min="-50" max="50" value="0"
                                           oninput="updateLuminosityValue(this.value)">
                                </div>
                                <div class="luminosity-btn-row">
                                    <button class="btn btn-full" onclick="applyLuminosityPostProcess()">Apply Luminosity</button>
                                    <button class="btn btn-small" onclick="resetLuminositySlider()" title="Reset to default">‚Üª Reset</button>
                                </div>
                            </div>
                        </details>
                    </div>

                    <!-- Save/History box -->
                    <div class="save-history-box">
                        <span class="save-history-box-title">Save / History</span>
                        <button class="btn btn-primary btn-full btn-save-config btn-with-step" onclick="saveCurrentConfig()">
                            <span class="step-circle step-circle-btn">5</span>
                            Save recolor configuration
                        </button>
                        <div class="config-import-export-row">
                            <button class="btn" id="exportSavedBtn" onclick="exportAllConfigs()">Export</button>
                            <button class="btn" onclick="document.getElementById('configFileInput').click()">Import</button>
                        </div>
                        <input type="file" id="configFileInput" accept=".json" style="display:none" onchange="importConfigFile(event)">
                        <button class="btn btn-full btn-download-recolor btn-with-step" id="downloadRecolorBtn" onclick="downloadImage()">
                            <span class="step-circle step-circle-btn">6</span>
                            Download Recolored Image
                        </button>
                        <div class="config-history-header">Recolor History</div>
                        <div class="config-list" id="configList"></div>
                        <details class="what-is-this-collapsible" id="whatIsThisCollapsible">
                            <summary class="what-is-this-summary">What is this?</summary>
                            <div class="what-is-this-content">
                                <div class="witi-step">
                                    <span class="witi-icon">üíæ</span>
                                    <span class="witi-text">When you see a recolor you like, hit <strong>Save Recolor Configuration</strong> or go to the History list and hit save next to any entry.</span>
                                </div>
                                <div class="witi-step">
                                    <span class="witi-icon">üì¶</span>
                                    <span class="witi-text">When you're done, hit <strong>Export</strong> and all your saved configurations will be recorded in one file. Hold onto that file and your image.</span>
                                </div>
                                <div class="witi-step">
                                    <span class="witi-icon">üîÑ</span>
                                    <span class="witi-text">You can reload your image and the configuration file at any time to pick up where you left off.</span>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>

                <div id="statusPanel" class="status"></div>
            </div>
        </div>

        <footer class="site-footer">
            <h3>Credits</h3>
            <p>With thanks to original code referenced from the
                <a href="https://recolor.cs.princeton.edu/demo/index.html" target="_blank" rel="noopener noreferrer">Princeton Recoloring Demo</a></p>
            <p>Inspiration &amp; reference:</p>
            <ul class="credits-links">
                <li><a href="https://github.com/ziap/repalette" target="_blank" rel="noopener noreferrer">github.com/ziap/repalette</a></li>
                <li><a href="https://github.com/ashish0kumar/tint" target="_blank" rel="noopener noreferrer">github.com/ashish0kumar/tint</a></li>
                <li><a href="https://github.com/rupareddy5/Palette-based-photo-recoloring" target="_blank" rel="noopener noreferrer">github.com/rupareddy5/Palette-based-photo-recoloring</a></li>
                <li><a href="https://github.com/pipi3838/DIP_Final" target="_blank" rel="noopener noreferrer">github.com/pipi3838/DIP_Final</a></li>
                <li><a href="https://github.com/danielgafni/repalette" target="_blank" rel="noopener noreferrer">github.com/danielgafni/repalette</a></li>
                <li><a href="https://github.com/b-z/photo_recoloring" target="_blank" rel="noopener noreferrer">github.com/b-z/photo_recoloring</a></li>
                <li><a href="https://www.realtimecolors.com/" target="_blank" rel="noopener noreferrer">realtimecolors.com</a></li>
            </ul>
        </footer>
    </div>

    <!-- Hidden elements for origin count tracking (still used by JS) -->
    <input type="hidden" id="originCountDisplay" value="5">

    <script src="app.js"></script>
</body>
</html>
